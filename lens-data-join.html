<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../iron-input/iron-input.html"> 

<!--
A data component for joining two columns together to create a new column.

Example:

    <lens-data-join></lens-data-join>

@element lens-data-join
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://lenses.github.io/lens-data-join
@demo
-->

<dom-module id="lens-data-join" attributes="input output">

  <link rel="stylesheet" href="lens-data-join.css">

  <template>
    <div class="lens-container lens-data">

      <label>Columns to join:</label>
        <template is="dom-repeat" items="{{inputKeys}}">
          <span class="columnName" on-click="_toggleSelected">{{item}}</span>
        </template>

      <label>Join with:</label>
      <input style="border: 2px solid #eee; padding: 3px; " is="iron-input" bind-value="{{joinString}}" placeholder="" type="text">

      <label>New column name: </label>
      <input style="border: 2px solid #eee; padding: 3px;" is="iron-input" bind-value="{{newColumnName}}">

    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is: 'lens-data-join',

    properties: {
      /**
       *  Input data
       *
       *  @property input
       *  @type Array
       *  @default []
       */
      input: {
        type: Array,
        value: [],
        observer: "_inputChanged"
      },

      /**
       *  Output data
       *
       *  @property output
       *  @type Array
       *  @default []
       */
      output: {
        type: Array,
        value: [],
        notify: true,
        readOnly: true
      },

      /**
       *  Array containing labels of the columns to be joined.
       *  
       *  @property selectedColumns
       *  @type Array
       *  @default []
       */
      selectedColumns: {
        type: Array,
        value: [],
        observer: "_selectedColumnsChanged"
      },

      /**
       *  A string to place between each joined item in the new column.
       *
       *  @property joinString
       *  @type String
       *  @default ", "
       */
      joinString: {
        type: String,
        value: ", ",
        observer: "_joinStringChanged"
      },

      /**
       *  Name of the new column.
       *
       *  @property newColumnName
       *  @type String
       *  @default ""
       */
      newColumnName: {
        type: String,
        value: "new column",
        observer: "_newColumnNameChanged"
      },

      /**
       *  If false, the original columns will be removed from output.
       *  
       *  @property keepOriginalData
       *  @type Boolean
       *  @default true
       */
      keepOriginalData: {
        type: Boolean,
        value: true
      }
    },

    _calculateOutput: function(){
      var self = this,
          inputLength = self.input.length;

      for (var i=0; i<self.input.length;i++){
        var stringsToJoin = self.selectedColumns.map(function(key){
          return self.input[i][key];
        });

        if(self.keepOriginalData){
          self.output[i] = self.input[i];
        } else {
          self.output[i] = {};            
        }
        self.output[i][self.newColumnName] = stringsToJoin.join(self.joinString);
      }

      // fire event
      self.fire('lens-output-changed', self);
    },

    _toggleSelected: function(e, detail){
      var self = this;
      var selection = e.target;
      selection.classList.toggle('selected');

      var selected = self.querySelectorAll('.selected');

      self.selectedColumns = [].map.call(selected, function(item) { return item.textContent});
    },

    // CHANGE OBSERVERS
    _inputChanged: function(){
      var self = this;

      var input = self.input;

      self.inputKeys = self.input[0] ? Object.keys(self.input[0]) : []; // columns to choose from
      self._calculateOutput();
    },
    _selectedColumnsChanged: function(){
      var self = this;
      self._calculateOutput();
    },
    _joinStringChanged: function(){
      var self = this;
      self._calculateOutput();
    },
    _newColumnNameChanged: function(newValue, oldValue){
      var self = this;
      
      // Remapping triggers the change in an observer
      self.output = self.output.map(function(item){
        item[newValue] = item[oldValue];
        delete item[oldValue];
        return item;
      });

      self._calculateOutput();
    }

  });
</script>
